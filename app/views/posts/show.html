<script>
  const currentUserQuery = ['id', 'name']
  const postQuery = {
    id: true,
    title: true,
    body: true,
    reactionSummary: true,
    user: ['id', 'name'],
    createdAt: true,
    myReaction: 'kind',
    comments: { id: true, body: true, reactionSummary: true, user: ['id', 'name'], myReaction: 'kind' }
  }
  const currentUserModel = new ArSyncModel({ api: 'profile', query: currentUserQuery })
  const postModel = new ArSyncModel(
    {
      api: 'post',
      params: { id: location.pathname.match(/\d+/)[0] },
      query: postQuery
    }
  )
  ArSyncModel.waitForLoad(currentUserModel, postModel).then(() => {
    const data = { currentUser: currentUserModel.data || {}, post: postModel.data || {} }
    new Vue({ el: '#syncbody', data })
  })
</script>
<div id='syncbody' v-cloak>
  <h1>
    {{ post.title }}
    &nbsp;
    <a :href="'/posts/' + post.id + '/edit'" v-if='post.user.id == currentUser.id'>
      <i class='material-icons'>edit</i>
    </a>
  </h1>
  <p>
    <b>
      author: <a :href="'/users/' + post.user.id">{{ post.user.name }}</a>
      &nbsp;&nbsp;date: {{ post.createdAt }}
    </b>
  </p>
  <article>
    {{ post.body }}
  </article>
  <reactions :url="'/posts/' + post.id + '/reaction'" :summary='post.reactionSummary' :mine='post.myReaction' iconclass='material-icons-large'></reactions>
  <hr>
  <div style='margin-left: 50px'>
    <div v-for='comment in post.comments'>
      <p>
        <b>
          <a :href="'/users/' + comment.user.id">{{ comment.user.name }}</a>
          :&nbsp;
        </b>
        <span>{{ comment.body }}</span>
        &nbsp;
        <a :href="'/comments/' + comment.id"><i class='material-icons'>link</i></a>
        <span v-if='comment.user.id == currentUser.id'>
          &nbsp;
          <a :href="'/comments/' + comment.id + '.json'" data-remote='true' data-method='delete'>
            <i class='material-icons'>clear</i>
          </a>
          &nbsp;
          <a :href="'/comments/' + comment.id + '/edit'">
            <i class='material-icons'>edit</i>
          </a>
        </span>
      </p>
      <reactions :url="'/comments/' + comment.id + '/reaction'" :summary='comment.reactionSummary' :mine='comment.myReaction'></reactions>
      <hr>
    </div>
  </div>

  <comment-form :post_id='post.id'></comment-form>
</div>
